# Storage System Quick Reference\n\n## Installation\n\n```bash\ncd cloud-service\nnpm install\n```\n\n## Basic Usage\n\n```typescript\nimport { StorageManager } from './src/services/storageManager';\n\nconst manager = new StorageManager('./.miaoda');\nawait manager.initialize();\nawait manager.start();\n\n// Get stats\nconst stats = await manager.getStorageStats();\n\n// Compress\nconst result = await manager.compress();\n\n// Cleanup\nconst cleanup = await manager.cleanup();\n\n// Monitor\nconst report = await manager.getMonitorReport();\n\nawait manager.stop();\n```\n\n## API Endpoints\n\n### Statistics\n```\nGET /api/v1/storage/stats\nGET /api/v1/storage/monitor\nGET /api/v1/storage/cleanup-stats\nGET /api/v1/storage/history\n```\n\n### Operations\n```\nPOST /api/v1/storage/compress\nPOST /api/v1/storage/cleanup\n```\n\n### Snapshots\n```\nGET /api/v1/storage/snapshots\nPOST /api/v1/storage/snapshots/:id/extract\nDELETE /api/v1/storage/snapshots/:id\nPOST /api/v1/storage/snapshots/:id/verify\n```\n\n### Configuration\n```\nGET /api/v1/storage/config\nPUT /api/v1/storage/config\n```\n\n## Configuration\n\n### Compression\n```typescript\n{\n  sizeThreshold: 2 * 1024 * 1024 * 1024,      // 2GB\n  timeThreshold: 30 * 24 * 60 * 60 * 1000,    // 30 days\n  targetSize: 200 * 1024 * 1024,              // 200MB\n  keepRecent: 7 * 24 * 60 * 60 * 1000,        // 7 days\n  compressionLevel: 9                         // 1-9\n}\n```\n\n### Cleanup\n```typescript\n{\n  oldSnapshotsAge: 90 * 24 * 60 * 60 * 1000,  // 90 days\n  tempFilesAge: 1 * 24 * 60 * 60 * 1000,      // 1 day\n  errorLogsAge: 30 * 24 * 60 * 60 * 1000,     // 30 days\n  enableAutoCleanup: true,\n  cleanupInterval: 60 * 60 * 1000             // 1 hour\n}\n```\n\n## Common Tasks\n\n### Get Storage Stats\n```typescript\nconst result = await manager.getStorageStats();\nconsole.log(result.data.totalSizeFormatted);\n```\n\n### Compress Old Data\n```typescript\nconst result = await manager.compress();\nconsole.log(`Compressed ${result.data.filesCompressed} files`);\nconsole.log(`Ratio: ${result.data.compressionRatio}%`);\n```\n\n### Run Cleanup\n```typescript\nconst result = await manager.cleanup();\nconsole.log(`Freed: ${result.data.totalSpaceFreedFormatted}`);\n```\n\n### Get Monitor Report\n```typescript\nconst result = await manager.getMonitorReport();\nresult.data.alerts.forEach(alert => {\n  console.log(`${alert.type}: ${alert.message}`);\n});\n```\n\n### List Snapshots\n```typescript\nconst result = await manager.getSnapshots();\nresult.data.forEach(snapshot => {\n  console.log(`${snapshot.date}: ${snapshot.compressedSizeFormatted}`);\n});\n```\n\n### Extract Snapshot\n```typescript\nconst result = await manager.extractSnapshot(\n  'snapshot-id',\n  '/target/directory'\n);\n```\n\n### Verify Snapshot\n```typescript\nconst result = await manager.verifySnapshot('snapshot-id');\nconsole.log(`Valid: ${result.data.isValid}`);\n```\n\n### Update Configuration\n```typescript\nmanager.updateConfig({\n  compression: { compressionLevel: 6 },\n  cleanup: { enableAutoCleanup: false }\n});\n```\n\n## Testing\n\n```bash\n# Run all tests\nnpm test -- tests/storage.test.ts\n\n# Run with coverage\nnpm test -- tests/storage.test.ts --coverage\n\n# Run specific test\nnpm test -- tests/storage.test.ts -t \"StorageService\"\n```\n\n## Troubleshooting\n\n### High Storage Usage\n1. Check stats: `GET /api/v1/storage/stats`\n2. Get recommendations: `GET /api/v1/storage/monitor`\n3. Compress: `POST /api/v1/storage/compress`\n\n### Compression Failed\n1. Check disk space\n2. Verify permissions\n3. Try dry-run: `POST /api/v1/storage/compress?dryRun=true`\n4. Check error logs\n\n### Snapshot Issues\n1. Verify: `POST /api/v1/storage/snapshots/:id/verify`\n2. Extract to test: `POST /api/v1/storage/snapshots/:id/extract`\n3. Delete if corrupted: `DELETE /api/v1/storage/snapshots/:id`\n\n## Performance Tips\n\n1. **Compression Level**\n   - Level 9: Maximum compression (slower)\n   - Level 6: Balanced (recommended)\n   - Level 1: Fast (less compression)\n\n2. **Monitoring Interval**\n   - 1 hour: Default\n   - 30 minutes: More frequent\n   - 4 hours: Less overhead\n\n3. **Cleanup Interval**\n   - 1 hour: Default\n   - 30 minutes: More aggressive\n   - 24 hours: Daily\n\n## File Structure\n\n```\n.miaoda/\n├── history/\n│   ├── sessions/\n│   ├── changes/\n│   └── snapshots/          # Compressed archives\n├── context/\n├── logs/\n├── cache/\n├── temp/                   # Temporary files\n└── .storage-history.json   # Historical data\n```\n\n## Response Examples\n\n### Storage Stats\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"totalSize\": 1073741824,\n    \"totalSizeFormatted\": \"1 GB\",\n    \"fileCount\": 5000,\n    \"directoryCount\": 50\n  }\n}\n```\n\n### Compression Report\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"snapshotId\": \"snapshot-1708500000000\",\n    \"originalSize\": 2147483648,\n    \"compressedSize\": 209715200,\n    \"compressionRatio\": 90.2,\n    \"filesCompressed\": 5000,\n    \"duration\": 45000\n  }\n}\n```\n\n### Monitor Report\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"alerts\": [\n      {\n        \"type\": \"warning\",\n        \"message\": \"Storage is approaching limit\",\n        \"suggestedAction\": \"Consider compressing old data\"\n      }\n    ],\n    \"trend\": {\n      \"trend\": \"increasing\",\n      \"growthRate\": 52428800,\n      \"estimatedFullDate\": \"2026-03-21T10:00:00.000Z\"\n    },\n    \"recommendations\": [\n      \"Schedule compression for old data\",\n      \"Review and clean up temporary files\"\n    ]\n  }\n}\n```\n\n## Key Classes\n\n- `StorageService` - Low-level utilities\n- `CompressionManager` - Compression logic\n- `CleanupManager` - Cleanup logic\n- `StorageMonitor` - Monitoring & alerts\n- `StorageManager` - Main orchestrator\n\n## Key Interfaces\n\n- `StorageStats` - Storage statistics\n- `CompressionConfig` - Compression configuration\n- `CompressionReport` - Compression result\n- `CleanupConfig` - Cleanup configuration\n- `CleanupReport` - Cleanup result\n- `StorageAlert` - Alert information\n- `StorageMonitorReport` - Monitor report\n- `SnapshotMetadata` - Snapshot information\n\n## Environment Variables\n\n```bash\nMIAODA_DIR=./.miaoda          # Storage directory\nNODE_ENV=production           # Environment\nPORT=3000                     # Server port\n```\n\n## Dependencies\n\n- `tar` - Archive operations\n- `zlib` - Compression\n- `fs` - File system\n- `path` - Path utilities\n- `express` - API framework\n\n## Documentation\n\n- `STORAGE_SYSTEM.md` - Complete reference\n- `STORAGE_IMPLEMENTATION_GUIDE.md` - Implementation guide\n- `STORAGE_SYSTEM_SUMMARY.md` - Summary\n- `STORAGE_QUICK_REFERENCE.md` - This file\n"