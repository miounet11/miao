name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: '22.x'
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ============================================================
  # Linux x64 — tar.gz + deb
  # ============================================================
  build-linux-x64:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ libx11-dev libxkbfile-dev libsecret-1-dev \
            libkrb5-dev fakeroot rpm dpkg-dev pkg-config

      - name: Install project dependencies
        run: |
          yarn install --network-timeout 180000 --ignore-engines
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          npm_config_build_from_source: true

      - name: Compile and minify
        run: |
          yarn gulp compile-build
          yarn gulp compile-extensions-build
          yarn gulp compile-extension-media
          yarn gulp minify-vscode

      - name: Package Linux x64
        run: yarn gulp vscode-linux-x64-min-ci

      - name: Create tar.gz
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          SRCDIR="../VSCode-linux-x64"
          if [ -d "$SRCDIR" ]; then
            mv "$SRCDIR" "../miaoda-linux-x64"
            tar -czf "miaoda-${VERSION}-linux-x64.tar.gz" -C ".." "miaoda-linux-x64"
          fi

      - name: Build deb package
        run: |
          yarn gulp vscode-linux-x64-prepare-deb
          yarn gulp vscode-linux-x64-build-deb
        continue-on-error: true

      - name: Collect artifacts
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p release-artifacts
          cp miaoda-*.tar.gz release-artifacts/ 2>/dev/null || true
          find .build/linux/deb -name "*.deb" -exec cp {} release-artifacts/miaoda-${VERSION}-linux-amd64.deb \; 2>/dev/null || true
          ls -lh release-artifacts/

      - uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: release-artifacts/*

  # ============================================================
  # macOS x64 (Intel)
  # ============================================================
  build-macos-x64:
    runs-on: macos-13
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          yarn install --network-timeout 180000 --ignore-engines
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          npm_config_build_from_source: true

      - name: Compile and minify
        run: |
          yarn gulp compile-build
          yarn gulp compile-extensions-build
          yarn gulp compile-extension-media
          yarn gulp minify-vscode

      - name: Package macOS x64
        run: yarn gulp vscode-darwin-x64-min-ci

      - name: Create DMG and ZIP
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          APP_DIR="../VSCode-darwin-x64"
          if [ -d "$APP_DIR" ]; then
            cd "$APP_DIR"
            zip -r -y -q "../miaoda-ide/Miaoda-${VERSION}-mac-x64.zip" .
            cd ../miaoda-ide
            hdiutil create -volname "Miaoda IDE" -srcfolder "$APP_DIR" -ov -format UDZO "Miaoda-${VERSION}-mac-x64.dmg" || true
          fi

      - name: Collect artifacts
        run: |
          mkdir -p release-artifacts
          cp Miaoda-*.dmg release-artifacts/ 2>/dev/null || true
          cp Miaoda-*.zip release-artifacts/ 2>/dev/null || true
          ls -lh release-artifacts/

      - uses: actions/upload-artifact@v4
        with:
          name: macos-x64
          path: release-artifacts/*

  # ============================================================
  # macOS arm64 (Apple Silicon)
  # ============================================================
  build-macos-arm64:
    runs-on: macos-14
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          yarn install --network-timeout 180000 --ignore-engines
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          npm_config_build_from_source: true

      - name: Compile and minify
        run: |
          yarn gulp compile-build
          yarn gulp compile-extensions-build
          yarn gulp compile-extension-media
          yarn gulp minify-vscode

      - name: Package macOS arm64
        run: yarn gulp vscode-darwin-arm64-min-ci

      - name: Create DMG and ZIP
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          APP_DIR="../VSCode-darwin-arm64"
          if [ -d "$APP_DIR" ]; then
            cd "$APP_DIR"
            zip -r -y -q "../miaoda-ide/Miaoda-${VERSION}-mac-arm64.zip" .
            cd ../miaoda-ide
            hdiutil create -volname "Miaoda IDE" -srcfolder "$APP_DIR" -ov -format UDZO "Miaoda-${VERSION}-mac-arm64.dmg" || true
          fi

      - name: Collect artifacts
        run: |
          mkdir -p release-artifacts
          cp Miaoda-*.dmg release-artifacts/ 2>/dev/null || true
          cp Miaoda-*.zip release-artifacts/ 2>/dev/null || true
          ls -lh release-artifacts/

      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: release-artifacts/*

  # ============================================================
  # Windows x64
  # ============================================================
  build-windows-x64:
    runs-on: windows-2022
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          yarn install --network-timeout 180000 --ignore-engines
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          npm_config_build_from_source: true

      - name: Compile and minify
        run: |
          yarn gulp compile-build
          yarn gulp compile-extensions-build
          yarn gulp compile-extension-media
          yarn gulp minify-vscode

      - name: Package Windows x64
        run: yarn gulp vscode-win32-x64-min-ci

      - name: Create ZIP
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}".TrimStart("v")
          $SrcDir = "..\VSCode-win32-x64"
          if (Test-Path $SrcDir) {
            Compress-Archive -Path "$SrcDir\*" -DestinationPath "Miaoda-${VERSION}-win-x64.zip" -Force
          }

      - name: Build Setup exe
        run: |
          yarn gulp vscode-win32-x64-inno-updater
          yarn gulp vscode-win32-x64-user-setup
        continue-on-error: true

      - name: Collect artifacts
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}".TrimStart("v")
          New-Item -ItemType Directory -Force -Path release-artifacts
          Copy-Item "Miaoda-*.zip" release-artifacts/ -ErrorAction SilentlyContinue
          Get-ChildItem -Recurse ".build\win32-x64" -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "release-artifacts\Miaoda-Setup-${VERSION}-win-x64.exe" -ErrorAction SilentlyContinue
          }
          Get-ChildItem release-artifacts/ -ErrorAction SilentlyContinue

      - uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: release-artifacts/*

  # ============================================================
  # Source code packages (always succeeds)
  # ============================================================
  build-source:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: ver
        run: |
          if [[ "$GITHUB_REF_NAME" == v* ]]; then
            echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=$(python3 -c 'import json; print(json.load(open(\"package.json\"))[\"version\"])')" >> $GITHUB_OUTPUT
          fi

      - name: Create source packages
        run: |
          VERSION=${{ steps.ver.outputs.VERSION }}
          mkdir -p /tmp/release-artifacts
          tar --exclude='.git' --exclude='node_modules' --exclude='out' --exclude='dist' \
            --exclude='.build' --exclude='__mocks__' \
            -czf "/tmp/release-artifacts/miaoda-${VERSION}-source.tar.gz" .
          zip -r -q "/tmp/release-artifacts/miaoda-${VERSION}-source.zip" . \
            -x ".git/*" "node_modules/*" "out/*" "dist/*" ".build/*" "__mocks__/*"
          ls -lh /tmp/release-artifacts/

      - uses: actions/upload-artifact@v4
        with:
          name: source
          path: /tmp/release-artifacts/*

  # ============================================================
  # Create GitHub Release with all artifacts
  # ============================================================
  create-release:
    needs: [build-linux-x64, build-macos-x64, build-macos-arm64, build-windows-x64, build-source]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: ver
        run: |
          if [[ "$GITHUB_REF_NAME" == v* ]]; then
            echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
            echo "TAG=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          else
            VER=$(python3 -c 'import json; print(json.load(open("package.json"))["version"])')
            echo "VERSION=${VER}" >> $GITHUB_OUTPUT
            echo "TAG=v${VER}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: List artifacts
        run: ls -lhR dist/ || echo "No artifacts"

      - name: Generate release notes
        run: |
          VERSION=${{ steps.ver.outputs.VERSION }}
          cat > release-notes.md << 'ENDOFNOTES'
          ## Miaoda IDE (妙搭)

          Official Release / 正式发布

          官网 / Website: https://www.imiaoda.cn

          ### Key Features

          - Universal LLM Support (OpenAI, Anthropic, DeepSeek, Ollama, etc.)
          - Smart Context Engine (95% accuracy, <45ms)
          - Transparent Cost System
          - Multi-Agent Orchestration (3-5x speedup)
          - Code Quality Guardian (82% auto-fix)
          - Cloud Storage Service (www.imiaoda.cn)

          ### Build from Source

          ```bash
          git clone https://github.com/miounet11/miao.git
          cd miao && yarn install && yarn compile
          ./scripts/code.sh
          ```

          [CHANGELOG](https://github.com/miounet11/miao/blob/main/CHANGELOG.md) | [ROADMAP](https://github.com/miounet11/miao/blob/main/ROADMAP.md)
          ENDOFNOTES
          sed -i 's/^          //' release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body_path: release-notes.md
          draft: false
          prerelease: false
          name: "Miaoda IDE v${{ steps.ver.outputs.VERSION }}"
          tag_name: ${{ steps.ver.outputs.TAG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
