name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g. v1.0.0)'
        required: true

permissions:
  contents: write

env:
  NODE_VERSION: '20.x'
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ============================================================
  # Linux builds (x64 + arm64) â€” tar.gz + deb + rpm
  # ============================================================
  build-linux-x64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ libx11-dev libxkbfile-dev libsecret-1-dev \
            fakeroot rpm dpkg-dev

      - name: Install project dependencies
        run: yarn install --network-timeout 180000
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Compile and package
        run: |
          yarn gulp compile-build
          yarn gulp compile-extensions-build
          yarn gulp compile-extension-media
          yarn gulp minify-vscode
          yarn gulp vscode-linux-x64-min-ci

      - name: Create tar.gz
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          SRCDIR="../VSCode-linux-x64"
          if [ -d "$SRCDIR" ]; then
            tar -czf "miaoda-${VERSION}-linux-x64.tar.gz" -C "$(dirname $SRCDIR)" "$(basename $SRCDIR)"
          fi

      - name: Build deb package
        run: |
          yarn gulp vscode-linux-x64-prepare-deb
          yarn gulp vscode-linux-x64-build-deb
        continue-on-error: true

      - name: Build rpm package
        run: |
          yarn gulp vscode-linux-x64-prepare-rpm
          yarn gulp vscode-linux-x64-build-rpm
        continue-on-error: true

      - name: Collect artifacts
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p release-artifacts
          cp miaoda-*.tar.gz release-artifacts/ 2>/dev/null || true
          find .build/linux/deb -name "*.deb" -exec cp {} release-artifacts/miaoda-${VERSION}-linux-amd64.deb \; 2>/dev/null || true
          find .build/linux/rpm -name "*.rpm" -exec cp {} release-artifacts/miaoda-${VERSION}-linux-x64.rpm \; 2>/dev/null || true
          ls -la release-artifacts/

      - uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: release-artifacts/*

  build-linux-arm64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ libx11-dev libxkbfile-dev libsecret-1-dev \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Install project dependencies
        run: yarn install --network-timeout 180000
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          npm_config_arch: arm64

      - name: Compile and package
        run: |
          yarn gulp compile-build
          yarn gulp compile-extensions-build
          yarn gulp compile-extension-media
          yarn gulp minify-vscode
          yarn gulp vscode-linux-arm64-min-ci
        continue-on-error: true

      - name: Create tar.gz
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          SRCDIR="../VSCode-linux-arm64"
          if [ -d "$SRCDIR" ]; then
            tar -czf "miaoda-${VERSION}-linux-arm64.tar.gz" -C "$(dirname $SRCDIR)" "$(basename $SRCDIR)"
          fi
        continue-on-error: true

      - name: Collect artifacts
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p release-artifacts
          cp miaoda-*.tar.gz release-artifacts/ 2>/dev/null || true
          ls -la release-artifacts/ || echo "No artifacts"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: linux-arm64
          path: release-artifacts/*
          if-no-files-found: ignore

  # ============================================================
  # macOS builds (x64 + arm64) â€” dmg + zip
  # ============================================================
  build-macos-x64:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: yarn install --network-timeout 180000
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Compile and package
        run: |
          yarn gulp compile-build
          yarn gulp compile-extensions-build
          yarn gulp compile-extension-media
          yarn gulp minify-vscode
          yarn gulp vscode-darwin-x64-min-ci

      - name: Create DMG and ZIP
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          APP_DIR="../VSCode-darwin-x64"
          if [ -d "$APP_DIR" ]; then
            # ZIP
            cd "$APP_DIR"
            zip -r -y "../miaoda-ide/Miaoda-${VERSION}-mac-x64.zip" .
            cd ../miaoda-ide
            # DMG
            hdiutil create -volname "Miaoda IDE" -srcfolder "$APP_DIR" -ov -format UDZO "Miaoda-${VERSION}-mac-x64.dmg" || true
          fi

      - name: Collect artifacts
        run: |
          mkdir -p release-artifacts
          cp Miaoda-*.dmg release-artifacts/ 2>/dev/null || true
          cp Miaoda-*.zip release-artifacts/ 2>/dev/null || true
          ls -la release-artifacts/

      - uses: actions/upload-artifact@v4
        with:
          name: macos-x64
          path: release-artifacts/*

  build-macos-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: yarn install --network-timeout 180000
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Compile and package
        run: |
          yarn gulp compile-build
          yarn gulp compile-extensions-build
          yarn gulp compile-extension-media
          yarn gulp minify-vscode
          yarn gulp vscode-darwin-arm64-min-ci

      - name: Create DMG and ZIP
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          APP_DIR="../VSCode-darwin-arm64"
          if [ -d "$APP_DIR" ]; then
            cd "$APP_DIR"
            zip -r -y "../miaoda-ide/Miaoda-${VERSION}-mac-arm64.zip" .
            cd ../miaoda-ide
            hdiutil create -volname "Miaoda IDE" -srcfolder "$APP_DIR" -ov -format UDZO "Miaoda-${VERSION}-mac-arm64.dmg" || true
          fi

      - name: Collect artifacts
        run: |
          mkdir -p release-artifacts
          cp Miaoda-*.dmg release-artifacts/ 2>/dev/null || true
          cp Miaoda-*.zip release-artifacts/ 2>/dev/null || true
          ls -la release-artifacts/

      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: release-artifacts/*

  # ============================================================
  # Windows builds (x64 + arm64) â€” setup exe + zip
  # ============================================================
  build-windows-x64:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: yarn install --network-timeout 180000
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Compile and package
        run: |
          yarn gulp compile-build
          yarn gulp compile-extensions-build
          yarn gulp compile-extension-media
          yarn gulp minify-vscode
          yarn gulp vscode-win32-x64-min-ci

      - name: Create ZIP
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}".TrimStart("v")
          $SrcDir = "..\VSCode-win32-x64"
          if (Test-Path $SrcDir) {
            Compress-Archive -Path "$SrcDir\*" -DestinationPath "Miaoda-${VERSION}-win-x64.zip" -Force
          }

      - name: Build Setup exe
        run: |
          yarn gulp vscode-win32-x64-inno-updater
          yarn gulp vscode-win32-x64-user-setup
        continue-on-error: true

      - name: Collect artifacts
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}".TrimStart("v")
          New-Item -ItemType Directory -Force -Path release-artifacts
          Copy-Item "Miaoda-*.zip" release-artifacts/ -ErrorAction SilentlyContinue
          Get-ChildItem -Recurse ".build/win32-x64" -Filter "*.exe" | ForEach-Object {
            Copy-Item $_.FullName "release-artifacts/Miaoda-Setup-${VERSION}-win-x64.exe" -ErrorAction SilentlyContinue
          }
          Get-ChildItem release-artifacts/

      - uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: release-artifacts/*

  build-windows-arm64:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: yarn install --network-timeout 180000
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          npm_config_arch: arm64

      - name: Compile and package
        run: |
          yarn gulp compile-build
          yarn gulp compile-extensions-build
          yarn gulp compile-extension-media
          yarn gulp minify-vscode
          yarn gulp vscode-win32-arm64-min-ci
        continue-on-error: true

      - name: Create ZIP
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}".TrimStart("v")
          $SrcDir = "..\VSCode-win32-arm64"
          if (Test-Path $SrcDir) {
            Compress-Archive -Path "$SrcDir\*" -DestinationPath "Miaoda-${VERSION}-win-arm64.zip" -Force
          }
        continue-on-error: true

      - name: Collect artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release-artifacts
          Copy-Item "Miaoda-*.zip" release-artifacts/ -ErrorAction SilentlyContinue
          Get-ChildItem release-artifacts/ -ErrorAction SilentlyContinue

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-arm64
          path: release-artifacts/*
          if-no-files-found: ignore

  # ============================================================
  # Create GitHub Release with all artifacts
  # ============================================================
  create-release:
    needs: [build-linux-x64, build-linux-arm64, build-macos-x64, build-macos-arm64, build-windows-x64, build-windows-arm64]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== All release artifacts ==="
          ls -lhR dist/ || echo "No artifacts found"

      - name: Generate release notes
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          cat > release-notes.md << 'EOF'
          ## Miaoda IDE v${VERSION} (å¦™æ­)

          ðŸŽ‰ Official Release / æ­£å¼å‘å¸ƒ

          å®˜ç½‘ / Website: https://www.imiaoda.cn

          ### âœ¨ Key Features / ä¸»è¦ç‰¹æ€§

          - ðŸŒ Universal LLM Support (OpenAI, Anthropic, DeepSeek, Ollama, etc.)
          - ðŸ§  Smart Context Engine (95% accuracy, <45ms response)
          - ðŸ’° Transparent Cost System
          - ðŸ¤– Multi-Agent Orchestration (3-5x speedup)
          - ðŸ›¡ï¸ Code Quality Guardian (82% auto-fix rate)
          - â˜ï¸ Cloud Storage Service (www.imiaoda.cn)

          ### ðŸ“¥ Downloads / ä¸‹è½½

          | Platform | Arch | File |
          |----------|------|------|
          | Windows | x64 | `Miaoda-${VERSION}-win-x64.zip` |
          | Windows | arm64 | `Miaoda-${VERSION}-win-arm64.zip` |
          | macOS | Intel | `Miaoda-${VERSION}-mac-x64.dmg` / `.zip` |
          | macOS | Apple Silicon | `Miaoda-${VERSION}-mac-arm64.dmg` / `.zip` |
          | Linux | x64 | `miaoda-${VERSION}-linux-x64.tar.gz` |
          | Linux | arm64 | `miaoda-${VERSION}-linux-arm64.tar.gz` |
          | Linux | deb (x64) | `miaoda-${VERSION}-linux-amd64.deb` |
          | Linux | rpm (x64) | `miaoda-${VERSION}-linux-x64.rpm` |

          ### ðŸ“– Build from Source / ä»Žæºç ç¼–è¯‘

          ```bash
          git clone https://github.com/miounet11/miao.git
          cd miao && yarn install && yarn compile
          ./scripts/code.sh  # macOS/Linux
          ```

          Full changelog: [CHANGELOG.md](https://github.com/miounet11/miao/blob/main/CHANGELOG.md)
          EOF
          # Replace version placeholder
          sed -i "s/\${VERSION}/${VERSION}/g" release-notes.md

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body_path: release-notes.md
          draft: false
          prerelease: false
          name: "Miaoda IDE ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
