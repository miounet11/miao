name: Deploy

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-server:
    name: Deploy Server
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --production --network-timeout 180000

      - name: Compile
        run: yarn compile

      - name: Create deployment package
        run: |
          mkdir -p deploy
          tar -czf deploy/server.tar.gz \
            out/ \
            node_modules/ \
            package.json \
            product.json

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          scp -i ~/.ssh/deploy_key deploy/server.tar.gz ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            cd /opt/miaoda

            # Backup current version
            if [ -d "current" ]; then
              mv current backup-$(date +%Y%m%d-%H%M%S)
            fi

            # Extract new version
            mkdir -p current
            tar -xzf /tmp/server.tar.gz -C current/

            # Restart service
            sudo systemctl restart miaoda-server

            # Wait for health check
            sleep 10
            curl -f http://localhost:3000/health || exit 1

            echo "Deployment successful!"
          EOF

      - name: Run health check
        run: |
          sleep 5
          curl -f https://${{ secrets.DEPLOY_HOST }}/health || exit 1

      - name: Notify deployment success
        if: success()
        run: |
          echo "Deployment to ${{ github.event.inputs.environment || 'production' }} successful!"

      - name: Rollback on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            cd /opt/miaoda
            if [ -d "backup-*" ]; then
              LATEST_BACKUP=$(ls -td backup-* | head -1)
              rm -rf current
              mv $LATEST_BACKUP current
              sudo systemctl restart miaoda-server
              echo "Rolled back to previous version"
            fi
          EOF

  deploy-docker:
    name: Deploy Docker Containers
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    timeout-minutes: 30
    if: github.event_name == 'push' || github.event.inputs.environment == 'production'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            cd /opt/miaoda

            # Pull latest images
            docker-compose -f docker-compose.prod.yml pull

            # Backup database
            docker-compose -f docker-compose.prod.yml exec -T miaoda-server \
              sh -c 'sqlite3 /data/miaoda.db ".backup /data/backup-$(date +%Y%m%d-%H%M%S).db"' || true

            # Deploy with zero-downtime
            docker-compose -f docker-compose.prod.yml up -d --no-deps --build

            # Wait for services to be healthy
            sleep 30
            docker-compose -f docker-compose.prod.yml ps

            # Health check
            curl -f http://localhost:3000/health || exit 1

            echo "Docker deployment successful!"
          EOF

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [deploy-server]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-package
          path: release/

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges)
          else
            CHANGELOG=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s" --no-merges)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body: |
            ## Miaoda IDE ${{ github.ref_name }}

            ### Changes
            ${{ steps.changelog.outputs.changelog }}

            ### Installation

            Download the appropriate package for your platform:
            - Linux: `miaoda-ide-linux-x64.tar.gz`
            - Windows: `miaoda-ide-win32-x64.tar.gz`
            - macOS: `miaoda-ide-darwin-x64.tar.gz`

            ### Docker
            ```bash
            docker pull miaoda/miaoda-ide:${{ github.ref_name }}
            ```

            ### Checksums
            See `checksums.txt` for SHA256 checksums of all artifacts.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-documentation:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: [create-github-release]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update version in docs
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          find docs -type f -name "*.md" -exec sed -i "s/version: .*/version: $VERSION/g" {} +

      - name: Deploy documentation
        run: |
          echo "Documentation deployment placeholder"
          # Add documentation deployment logic here
          # e.g., deploy to GitHub Pages, Netlify, etc.
